# Deployment Azure
- [Step-by-Step Guide to Deploying Azure Web Apps (Windows) with IIS](#step-by-step-guide-to-deploying-azure-web-apps-windows-with-iis)
  - [Setting up a new Azure Web App (Windows) with IIS](#setting-up-a-new-azure-web-app-windows-with-iis)
  - [Adjusting the Web App Configuration](#adjusting-the-web-app-configuration)
  - [Modifying the GitHub Action](#modifying-the-github-action)

# Step-by-Step Guide to Deploying Azure Web Apps (Windows) with IIS

This guide assumes you already have permission to access the Azure subscription.

## Setting up a new Azure Web App (Windows) with IIS

These instructions pertain to the staging environment. For the production environment, follow the same steps, but with a different web app name.

1. Navigate to the [Azure Portal](https://portal.azure.com/)
1. Select **Create a resource**
1. Choose **Create a Web App**
1. In the Basic Tab
   - Choose your existing subscription and resource group
   - Under Instance Details, enter:
      - Name: **stride-website-staging**
      - Publish: **Code**
      - Runtime stack: **ASP.NET V4.8**
      - OS: **Windows**
      - Region: as the current web
      - Pricing Plan - An existing App Service Plan should appear if the region and resource group match that of the existing web app. Currently we use **Standard S1**.
      - Click **Next**
1. In the Deployment Tab - This step can be completed later if preferred.
   - Enable Continuous deployment
   - Select account, organisation `Stride`, repository `stride-website` and branch `staging-next`
   - Click **Next**
1. In the Monitoring Tab
   - Leave all settings as default
   - Click **Next**
1. Monitoring Tab
   - Disable Application Insights - This is not needed at this stage
   - Click **Next**
1. In the Tags Tab
   - Leave this blank unless you wish to add tags
   - Click **Next**
1. In the Review Tab
   - Review your settings
   - Click **Create**
   - The GitHub Action will be added to the repository and run automatically. It will fail at this stage, but this will be resolved in the subsequent steps.

## Adjusting the Web App Configuration

1. Proceed to the newly created Web App
1. Click on **Configuration**
1. Select **General Settings**
1. Change the Http Version to **2.0**
1. Click **Save** to apply the changes

## Modifying the GitHub Action

The previous step will have added a GitHub Action to the repository, which will fail at this point. You need to modify the GitHub Action to correct the issue.

1. Navigate to the repository
1. Select Actions
1. You have the option to stop the currently running action
1. Locate the new GitHub Action *(within this folder Stride Website -> staging-next repo -> .github -> workflows)* which was automatically generated by the Azure Portal. We will need to reference the properties app-name and publish-profile and disable the push trigger.
   - To disable the push trigger, retain only **workflow_dispatch** (manual trigger) as shown below:
    ```
    on:
    #  push:
    #    branches:
    #      - staging-next
        workflow_dispatch:
    ```
1. Open the `stride-website-staging-azure.yml` workflow and update it with the properties from the previous step. Save your changes.
1. This workflow may also need to be added to the production branch master if it is not already there.
1. Execute the workflow stride-website-staging-azure.yml. Ensure you select the correct branch staging-next and click **Run workflow**. This action will deploy the website to the Azure Web App.
